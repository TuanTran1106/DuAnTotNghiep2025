<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản Lý Kho - Đồng Hồ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
    <style>
        /* [Existing styles remain unchanged] */
        body {
            background-color: #e9ecef;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #2d3748;
        }

        .container {
            max-width: 1400px;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.2s, transform 0.3s;
            background-color: #ffffff;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-5px);
        }

        .product-img {
            width: 50px;
            height: auto;
            border-radius: 8px;
        }

        .btn-custom {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            font-size: 14px;
            transition: background-color 0.2s, color 0.2s;
        }

        .btn-primary {
            background-color: #1e3a8a;
            border-color: #1e3a8a;
        }

        .btn-primary:hover {
            background-color: #1e40af;
            border-color: #1e40af;
        }

        .btn-outline-secondary {
            border-color: #6b7280;
            color: #6b7280;
        }

        .btn-outline-secondary:hover {
            background-color: #6b7280;
            color: #ffffff;
        }

        .btn-lich-su, .import-excel, .add-product {
            font-size: 14px;
            background-color: #ffffff;
            border-color: #6b7280;
        }

        .btn-lich-su:hover, .import-excel:hover, .add-product:hover {
            background-color: #f1f5f9;
            color: #4b5563;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .modal-footer {
            background-color: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            transition: border-color 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-floating:hover > input:not(:focus):not(:placeholder-shown) + label,
        .form-floating:hover > input:not(:focus):placeholder-shown + label {
            transform: scale(0.85) translateY(-1.5rem);
            opacity: 0.85;
            transition: all 0.2s ease;
        }

        .sao {
            color: red;
        }

        .pagination .page-link {
            border-radius: 8px;
            margin: 0 4px;
            color: #1e3a8a;
            font-size: 14px;
        }

        .pagination .page-item.active .page-link {
            background-color: #1e3a8a;
            border-color: #1e3a8a;
            color: #ffffff;
        }

        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 10;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3a8a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .custom-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 280px;
            max-width: 400px;
            padding: 15px 20px;
            border-radius: 8px;
            color: #fff;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(-20px);
            animation: slideIn 0.3s ease-out forwards, fadeOut 0.5s ease-in 5s forwards;
        }

        .toast-success {
            background-color: #ffffff;
            color: #218838;
        }

        .toast-error {
            background-color: #ffffff;
            color: red;
        }

        @keyframes slideIn {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-20px); }
        }

        .no-data {
            color: rgba(107, 114, 128, 0.6);
            font-style: italic;
            font-size: 1rem;
        }

        .no-data i {
            opacity: 0.6;
            vertical-align: middle;
        }

        .table-container {
            position: relative;
        }

        .product-image {
            cursor: pointer;
            transition: transform 0.2s ease;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .product-image:hover {
            transform: scale(1.05);
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        /* Modal phóng to hình ảnh */
        .image-modal {
            z-index: 1060;
        }

        .image-modal .modal-dialog {
            max-width: 90vw;
            width: auto;
            margin: 2rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 4rem);
        }

        .image-modal .modal-content {
            background: transparent;
            border: none;
            box-shadow: none;
            width: auto;
            max-width: none;
        }

        .image-modal .modal-body {
            padding: 20px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .zoomed-image {
            max-width: 85vw;
            max-height: 80vh;
            width: auto;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            object-fit: contain;
        }

        .close-zoom {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #dc3545;
            color: #dc3545;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        .close-zoom:hover {
            background: #dc3545;
            color: #fff;
            transform: scale(1.1);
        }

        .image-info {
            background: #1e3a8a;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 15px;
            display: inline-block;
            max-width: 85vw;
            word-wrap: break-word;
        }

        /* Responsive cho mobile */
        @media (max-width: 768px) {
            .image-modal .modal-dialog {
                margin: 1rem;
                min-height: calc(100vh - 2rem);
            }

            .zoomed-image {
                max-width: 95vw;
                max-height: 70vh;
            }

            .image-info {
                max-width: 95vw;
                font-size: 14px;
            }

            .close-zoom {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }

        .table-container {
            background-color: #fff;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }
        tr {
            background-color: #fff;
            border-radius: 10px;
        }
        td {
            padding: 10px;
            vertical-align: middle;
        }
        .watch-image img {
            width: 80px;
            height: auto;
            border-radius: 5px;
            cursor: pointer;
        }
        .watch-info {
            font-family: Arial, sans-serif;
        }
        .watch-name {
            font-weight: bold;
            color: #333;
        }
        .watch-price {
            color: #ff0000;
            font-size: 18px;
            font-weight: bold;
        }
        .watch-stock {
            color: #666;
            font-size: 14px;
        }
        .stock-number {
            color: #000;
        }
        .button-group {
            text-align: right;
        }
        .btn {
            padding: 5px 10px;
            margin-left: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-xoa {
            background-color: #ff3333;
            color: #fff;
        }
        .btn-sua {
            background-color: #28a745;
            color: #fff;
        }
        .btn-nhap, .btn-xuat {
            background-color: #007bff;
            color: #fff;
        }
        .btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="antialiased">
<div class="d-flex">
    <div class="flex-1 p-6">
        <div class="container mx-auto">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-900">Quản Lý Kho</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-custom btn-lich-su" data-bs-toggle="modal" data-bs-target="#historyModal">
                        Lịch Sử
                    </button>
                    <button class="btn btn-custom import-excel" data-bs-toggle="modal" data-bs-target="#importModal">
                        Nhập Excel
                    </button>
                    <button class="btn btn-custom add-product" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        Thêm Sản Phẩm
                    </button>
                </div>
            </div>

            <!-- header  -->
            <div class="row g-4 mb-6">
                <div class="col-md-3">
                    <div class="card p-4">
                        <h5 class="card-title text-sm font-medium text-gray-600">Tổng Sản Phẩm</h5>
                        <p class="card-text text-2xl font-semibold text-gray-900" th:text="${totalProduct}"></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-4">
                        <h5 class="card-title text-sm font-medium text-gray-600">Tổng Tồn Kho</h5>
                        <p class="card-text text-2xl font-semibold text-gray-900" th:text="${totalProductInSock}"></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-4">
                        <h5 class="card-title text-sm font-medium text-gray-600">Giá Trị Tồn Kho</h5>
                        <p class="card-text text-2xl font-semibold text-gray-900" th:text="${totalPriceInSock}"></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-4">
                        <h5 class="card-title text-sm font-medium text-gray-600">Sắp Hết Hàng</h5>
                        <p class="card-text text-2xl font-semibold text-gray-900" th:text="${totalProductIsOut}"></p>
                    </div>
                </div>
            </div>

            <!-- filter -->
            <div class="table-container mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Danh Sách Tồn Kho</h3>
                <form class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label text-sm font-medium">Từ khóa</label>
                        <input style="font-size: 14px" type="text" class="form-control" name="keyword"
                               placeholder="Tên sản phẩm...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-sm font-medium">Thương hiệu</label>
                        <select style="font-size: 14px" class="form-select" name="thuongHieu">
                            <option style="font-size: 14px" value="">-- Tất cả --</option>
                            <option style="font-size: 14px" th:each="brand : ${listBrand}" th:value="${brand.id}"
                                    th:text="${brand.tenThuongHieu}"></option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-sm font-medium">Danh mục</label>
                        <select style="font-size: 14px" class="form-select" name="danhMuc">
                            <option style="font-size: 14px" value="">-- Tất cả --</option>
                            <option style="font-size: 14px" th:each="dm : ${listCategory}" th:value="${dm.id}"
                                    th:text="${dm.tenDanhMuc}"></option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex gap-2">
                        <button style="font-size: 14px" class="btn btn-custom btn-primary btn-filter" type="submit">
                            <i class="bi bi-funnel me-1"></i> Bộ Lọc
                        </button>
                        <a style="font-size: 14px" href="/quan-ly/kho"
                           class="btn btn-custom btn-outline-secondary btn-reset">Reset</a>
                    </div>
                </form>
            </div>

            <!-- conttent table -->
            <div class="table-container" id="table-container">
                <div class="loading-overlay" id="loading-overlay">
                    <div class="loading-spinner"></div>
                </div>
                <div class="table-responsive">
                    <table>
                        <tr th:if="${listInSock.isEmpty()}">
                            <td colspan="3" class="text-center py-3">
                                <span class="no-data">
                                    <i class="bi bi-database fs-5 me-2"></i>
                                    <em style="font-size: 14px">Không có dữ liệu...</em>
                                </span>
                            </td>
                        </tr>
                        <tr th:each="sock : ${listInSock}">
                            <td class="watch-image">
                                <img th:src="@{'/img/' + ${sock.hinhAnh}}" alt="Ảnh sản phẩm"
                                     class="product-image"
                                     onclick="openImageModal(this)">
                            </td>
                            <td class="watch-info">
                                <div class="watch-name" th:text="${sock.tenSanPham}"></div>
                                <div class="watch-price"
                                     th:text="${#numbers.formatDecimal(sock.giaNhap, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                </div>
                                <div class="watch-stock">
                                    Số lượng còn lại:
                                    <span class="stock-number" th:text="${sock.soLuong}">
                                    </span>
                                </div>
                            </td>
                            <td class="button-group">
                                <a class="btn btn-remove btn-xoa"
                                   th:attr="data-id=${sock.id}"
                                   title="Xóa sản phẩm"
                                   data-bs-placement="top"
                                   data-bs-toggle="modal"
                                   data-bs-target="#deleteModal">
                                    Xóa mặt hàng
                                </a>
                                <a class="btn btn-edit btn-sua"
                                   th:attr="data-id=${sock.id}"
                                   title="Cập nhật số lượng mới"
                                   data-bs-placement="top"
                                   data-bs-toggle="modal"
                                   data-bs-target="#editModal">
                                    Chỉnh sửa số lượng
                                </a>
                                <a class="btn btn-buy btn-nhap"
                                   th:attr="data-id=${sock.id}"
                                   title="Nhập hàng"
                                   data-bs-placement="top"
                                   data-bs-toggle="modal"
                                   data-bs-target="#enter">
                                    Nhập hàng
                                </a>
                                <a class="btn btn-buy btn-xuat"
                                   th:attr="data-id=${sock.id}"
                                   title="Xuất hàng"
                                   data-bs-placement="top"
                                   data-bs-toggle="modal"
                                   data-bs-target="#export">
                                    Xuất hàng
                                </a>
                            </td>
                        </tr>
                    </table>
                </div>

                <!-- phân trang -->
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" th:classappend="${startPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/quan-ly/kho(page=${startPage - 1})}">«</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPage - 1)}"
                            th:classappend="${i == startPage} ? 'active'">
                            <a class="page-link" th:href="@{/quan-ly/kho(page=${i})}" th:text="${i + 1}"></a>
                        </li>
                        <li class="page-item" th:classappend="${startPage == totalPage - 1} ? 'disabled'">
                            <a class="page-link" th:href="@{/quan-ly/kho(page=${startPage + 1})}">»</a>
                        </li>
                    </ul>
                </nav>
            </div>

            <!--modal nhập hàng -->
            <div class="modal fade" id="enter" tabindex="-1">
                <div class="modal-dialog">
                    <form method="post" th:action="@{/quan-ly/kho/nhap}" th:object="${form}" id="formNhap">
                        <input type="hidden" name="id" id="nhap-id">
                        <div class="modal-content border-0 rounded shadow-sm">
                            <div class="modal-header bg-white border-bottom">
                                <h5 class="modal-title text-dark fw-semibold">Nhập Hàng</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Đóng"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="soLuongNhap" name="soLuong"
                                           placeholder="Số lượng nhập" min="1">
                                    <label style="font-size: 14px" for="soLuongNhap">Số lượng nhập <span
                                            class="text-danger">*</span></label>
                                    <div class="invalid-feedback" id="soLuongNhapError"></div>
                                </div>
                                <div class="form-floating" style="padding-top: 10px">
                                    <input type="text" class="form-control" id="ghiChu" name="ghiChuNhap"
                                           placeholder="Ghi chú">
                                    <label style="font-size: 14px" for="ghiChu">Ghi chú</label>
                                </div>
                            </div>
                            <div class="modal-footer bg-light border-top">
                                <button type="submit" class="btn btn-primary btn-sm">Lưu</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                                    Hủy
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- modalxuaasts hang -->
            <div class="modal fade" id="export" tabindex="-1">
                <div class="modal-dialog">
                    <form method="post" th:action="@{/quan-ly/kho/xuat}" id="formXuat">
                        <input type="hidden" name="id" id="xuat-id">
                        <div class="modal-content border-0 rounded shadow-sm">
                            <div class="modal-header bg-white border-bottom">
                                <h5 class="modal-title text-dark fw-semibold">Xuất Hàng</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Đóng"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="soLuongXuat" name="soLuong"
                                           placeholder="Số lượng xuất" min="1">
                                    <label style="font-size: 14px" for="soLuongXuat">Số lượng xuất <span
                                            class="text-danger">*</span></label>
                                    <div class="invalid-feedback" id="soLuongXuatError"></div>
                                </div>
                                <div class="form-floating" style="padding-top: 10px">
                                    <input type="text" class="form-control" id="ghiChuXuat" name="ghiChuXuat"
                                           placeholder="Ghi chú">
                                    <label style="font-size: 14px" for="ghiChuXuat">Ghi chú</label>
                                </div>
                            </div>
                            <div class="modal-footer bg-light border-top">
                                <button type="submit" class="btn btn-primary btn-sm">Lưu</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                                    Hủy
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- modal cập nhật s lượng -->
            <div class="modal fade" id="editModal" tabindex="-1">
                <div class="modal-dialog">
                    <form method="post" th:action="@{/quan-ly/kho/sua}" id="formSua">
                        <input type="hidden" name="id" id="sua-id">
                        <div class="modal-content border-0 rounded shadow-sm">
                            <div class="modal-header bg-white border-bottom">
                                <h5 class="modal-title text-dark fw-semibold">Cập Nhật Số Lượng</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Đóng"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="soLuongMoi" name="soLuong"
                                           placeholder="Số lượng mới" min="0">
                                    <label style="font-size: 14px" for="soLuongMoi">Số lượng mới <span
                                            class="text-danger">*</span></label>
                                    <div class="invalid-feedback" id="soLuongSuaError"></div>
                                </div>
                                <div class="form-floating" style="padding-top: 10px">
                                    <input type="text" class="form-control" id="ghiChuUpdate" name="ghiChuUpdate"
                                           placeholder="Ghi chú">
                                    <label style="font-size: 14px" for="ghiChuUpdate">Ghi chú</label>
                                </div>
                            </div>
                            <div class="modal-footer bg-light border-top">
                                <button type="submit" class="btn btn-primary btn-sm">Lưu</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                                    Hủy
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- modal lịch sử -->
            <div class="modal fade" id="historyModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <input type="hidden" name="id" id="lich-su-id">
                    <div class="modal-content border-0 rounded shadow-sm">
                        <div class="modal-header bg-white border-bottom">
                            <h5 class="modal-title text-dark fw-semibold">Lịch Sử Nhập/Xuất Kho</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                        </div>
                        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover text-sm text-center align-middle">
                                    <thead class="table-light">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Ngày Thực Hiện</th>
                                        <th scope="col">Tên Sản Phẩm</th>
                                        <th scope="col">Người Thực Hiện</th>
                                        <th scope="col">Loại Thao Tác</th>
                                        <th scope="col">Số Lượng</th>
                                        <th scope="col">Ghi Chú</th>
                                    </tr>
                                    </thead>
                                    <tbody id="historyBody">
                                    <tr th:each="history,start : ${listHistoryInSock}">
                                        <td th:text="${start.index + 1}"></td>
                                        <td th:text="${#temporals.format(history.thoiGian, 'dd/MM/yyyy HH:mm:ss')}"></td>
                                        <td th:text="${history.sanPhamChiTiet.sanPham.tenSanPham}"></td>
                                        <td th:text="${history.nhanVien.hoTen}"></td>
                                        <td th:text="${history.loai}"></td>
                                        <td th:text="${history.soLuong}"></td>
                                        <td th:text="${history.ghiChu}"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer bg-light border-top">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                                Đóng
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- modal import excel -->
            <div class="modal fade" id="importModal" tabindex="-1">
                <div class="modal-dialog">
                    <form method="post" enctype="multipart/form-data" th:action="@{/quan-ly/kho/import}">
                        <div class="modal-content border-0 rounded shadow-sm">
                            <div class="modal-header bg-white border-bottom">
                                <h5 class="modal-title text-dark fw-semibold">Nhập Dữ Liệu Từ Excel</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Đóng"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-floating">
                                    <input style="font-size: 14px" type="file" class="form-control" name="file"
                                           accept=".xlsx,.xls">
                                    <label style="font-size: 14px">Chọn file Excel <span
                                            class="text-danger">*</span></label>
                                </div>
                            </div>
                            <div class="modal-footer bg-light border-top">
                                <button type="submit" class="btn btn-primary btn-sm">Tải Lên</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                                    Hủy
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- modal thêm sản phâm -->
            <div class="modal fade" id="addProductModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <form method="post" th:action="@{/quan-ly/kho/them}" id="formThem" enctype="multipart/form-data"
                          onsubmit="return validateForm()">
                        <div class="modal-content border-0 rounded shadow-sm">
                            <div class="modal-header bg-white border-bottom">
                                <h5 class="modal-title text-dark fw-semibold">Thêm Sản Phẩm Mới</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Đóng"></button>
                            </div>
                            <div class="modal-body">
                                <div id="validationAlert" class="alert alert-danger d-none" role="alert">
                                    <ul id="validationErrors" class="mb-0"></ul>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="tenSanPham" name="tenSanPham"
                                                   maxlength="255" oninput="validateProductName()">
                                            <label for="tenSanPham">Tên sản phẩm <span
                                                    class="text-danger">*</span></label>
                                            <div class="invalid-feedback" id="tenSanPham-error"></div>
                                            <div class="form-text">Tối đa 255 ký tự</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <select style="font-size: 14px" class="form-select" id="thuongHieu"
                                                    name="thuongHieu"
                                                    onchange="validateBrand()">
                                                <option style="font-size: 14px" value="">-- Chọn thương hiệu --</option>
                                                <option style="font-size: 14px" th:each="brand : ${listBrand}"
                                                        th:value="${brand.id}"
                                                        th:text="${brand.tenThuongHieu}"></option>
                                            </select>
                                            <label for="thuongHieu">Thương hiệu <span
                                                    class="text-danger">*</span></label>
                                            <div class="invalid-feedback" id="thuongHieu-error"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <select style="font-size: 14px" class="form-select" id="danhMuc"
                                                    name="danhMuc"
                                                    onchange="validateCategory()">
                                                <option style="font-size: 14px" value="">-- Chọn danh mục --</option>
                                                <option style="font-size: 14px" th:each="dm : ${listCategory}"
                                                        th:value="${dm.id}" th:text="${dm.tenDanhMuc}"></option>
                                            </select>
                                            <label for="danhMuc">Danh mục <span class="text-danger">*</span></label>
                                            <div class="invalid-feedback" id="danhMuc-error"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="mauSac" name="mauSac"
                                                   maxlength="50" oninput="validateColor()">
                                            <label for="mauSac">Màu sắc <span class="text-danger">*</span></label>
                                            <div class="invalid-feedback" id="mauSac-error"></div>
                                            <div class="form-text">Tối đa 50 ký tự</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="kichThuoc" name="kichThuoc"
                                                   maxlength="20" oninput="validateSize()">
                                            <label for="kichThuoc">Kích thước <span class="text-danger">*</span></label>
                                            <div class="invalid-feedback" id="kichThuoc-error"></div>
                                            <div class="form-text">Tối đa 20 ký tự (VD: S, M, L, XL)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="chatLieu" name="chatLieu"
                                                   maxlength="100" oninput="validateMaterial()">
                                            <label for="chatLieu">Chất liệu <span class="text-danger">*</span></label>
                                            <div class="invalid-feedback" id="chatLieu-error"></div>
                                            <div class="form-text">Tối đa 100 ký tự</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="number" step="0.01" class="form-control" id="giaNhap"
                                                   name="giaNhap"
                                                   min="0" max="999999999" oninput="validatePrice()">
                                            <label for="giaNhap">Giá nhập (VNĐ) <span
                                                    class="text-danger">*</span></label>
                                            <div class="invalid-feedback" id="giaNhap-error"></div>
                                            <div class="form-text">Từ 0 đến 999,999,999 VNĐ</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="number" class="form-control" id="soLuong" name="soLuong"
                                                   min="1" max="999999" oninput="validateQuantity()">
                                            <label for="soLuong">Số lượng <span class="text-danger">*</span></label>
                                            <div class="invalid-feedback" id="soLuong-error"></div>
                                            <div class="form-text">Từ 1 đến 999,999</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="hinhAnh" class="form-label">Hình ảnh sản phẩm</label>
                                    <input type="file" class="form-control" id="hinhAnh" name="hinhAnh"
                                           accept="image/jpeg,image/jpg,image/png,image/gif"
                                           onchange="validateAndPreviewImage(this)">
                                    <div class="invalid-feedback" id="hinhAnh-error"></div>
                                    <div class="form-text">Chỉ chấp nhận file JPG, PNG, GIF. Tối đa 5MB.</div>
                                    <div id="imagePreview" class="mt-2" style="display: none;">
                                        <img id="preview" src="" alt="Preview" class="img-thumbnail"
                                             style="max-width: 200px; max-height: 200px;">
                                        <button type="button" class="btn btn-sm btn-outline-danger ms-2"
                                                onclick="removeImage()">
                                            <i class="fas fa-times"></i> Xóa
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer bg-light border-top">
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="fas fa-save me-1"></i>Lưu sản phẩm
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>Hủy
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- md thông abso -->
            <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 rounded shadow-sm">
                        <div class="modal-header bg-white border-bottom">
                            <h5 class="modal-title text-dark fw-semibold">Thông Báo</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                        </div>
                        <div class="modal-body">
                            <div id="notificationMessage" class="text-center"></div>
                        </div>
                        <div class="modal-footer bg-light border-top">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                                Đóng
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!--        modal phóng to anh?-->
            <div class="modal fade image-modal" id="imageModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body">
                            <button type="button" class="close-zoom" onclick="closeImageModal()">
                                <i class="bi bi-x"></i>
                            </button>
                            <img id="zoomedImage" src="" alt="" class="zoomed-image">
                            <div class="image-info">
                                <span id="productInfo"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--thong báo lỗi -->
            <div th:if="${successMessage}" class="custom-toast toast-success" id="toastSuccess">
                <i class="fas fa-check-circle toast-icon"></i>
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="custom-toast toast-error" id="toastError">
                <i class="fas fa-exclamation-circle toast-icon"></i>
                <span th:text="${errorMessage}"></span>
            </div>

            <!-- modal xác nhận xóa-->
            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 rounded shadow-sm">
                        <div class="modal-header bg-white border-bottom-0">
                            <h5 class="modal-title fw-semibold text-dark" id="deleteModalLabel">Xác nhận xóa sản
                                phẩm</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                        </div>
                        <div class="modal-body text-center px-4">
                            <p class="mb-0 text-secondary">
                                Bạn có chắc chắn muốn xóa sản phẩm này không?
                                <br>
                                <small class="text-muted">Hành động này không thể hoàn tác.</small>
                            </p>
                        </div>
                        <div class="modal-footer bg-light border-top-0 justify-content-center">
                            <form id="deleteForm" th:action="@{/quan-ly/kho/xoa}" method="post" class="d-inline">
                                <input type="hidden" id="xoa-id" name="id">
                                <button type="submit" class="btn btn-primary btn-sm">Xóa</button>
                            </form>
                            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" data-bs-dismiss="modal">
                                Hủy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
</body>

<!--scrip tổng-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // mở form
        document.querySelectorAll(".btn-nhap").forEach(btn => {
            btn.addEventListener("click", function () {
                const id = btn.getAttribute("data-id");
                document.getElementById("nhap-id").value = id;
            });
        });

        document.querySelectorAll(".btn-xuat").forEach(btn => {
            btn.addEventListener("click", function () {
                const id = btn.getAttribute("data-id");
                document.getElementById("xuat-id").value = id;
            });
        });

        document.querySelectorAll(".btn-xoa").forEach(btn => {
            btn.addEventListener("click", function () {
                const id = btn.getAttribute("data-id");
                document.getElementById("xoa-id").value = id;
            });
        });

        document.querySelectorAll(".btn-sua").forEach(btn => {
            btn.addEventListener("click", function () {
                const id = btn.getAttribute("data-id");
                document.getElementById("sua-id").value = id;
            });
        });

        document.querySelectorAll(".btn-lich-su").forEach(btn => {
            btn.addEventListener("click", function () {
                const id = btn.getAttribute("data-id");
                document.getElementById("lich-su-id").value = id;
            });
        });

        // loading khi click button
        document.querySelector(".btn-reset").addEventListener("click", function (e) {
            e.preventDefault();
            const loadingOverlay = document.getElementById("loading-overlay");
            loadingOverlay.style.display = "flex";
            setTimeout(() => {
                window.location.href = "/quan-ly/kho";
            }, 700);
        });

        document.querySelector(".btn-filter").addEventListener("click", function (e) {
            e.preventDefault();
            const loadingOverlay = document.getElementById("loading-overlay");
            loadingOverlay.style.display = "flex";
            const form = e.target.closest("form");
            setTimeout(() => {
                form.submit();
            }, 700);
        });

        // lable nút ở table
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        tooltipTriggerList.forEach(function (el) {
            new bootstrap.Tooltip(el);
        });

        const formNhap = document.getElementById('formNhap');
        const soLuongNhap = document.getElementById('soLuongNhap');
        const soLuongNhapError = document.getElementById('soLuongNhapError');

        const formXuat = document.getElementById('formXuat');
        const soLuongXuat = document.getElementById('soLuongXuat');
        const soLuongXuatError = document.getElementById('soLuongXuatError');

        const formSua = document.getElementById('formSua');
        const soLuongMoi = document.getElementById('soLuongMoi');
        const soLuongSuaError = document.getElementById('soLuongSuaError');

        function validateNumber(input, errorElem, min = 1) {
            const value = input.value.trim();
            if (!/^\d+$/.test(value)) {
                errorElem.textContent = 'Vui lòng nhập số nguyên hợp lệ.';
                input.classList.add('is-invalid');
                return false;
            } else if (parseInt(value, 10) < min) {
                errorElem.textContent = `Số lượng phải lớn hơn hoặc bằng ${min}.`;
                input.classList.add('is-invalid');
                return false;
            } else {
                errorElem.textContent = '';
                input.classList.remove('is-invalid');
                return true;
            }
        }

        formNhap.addEventListener('submit', e => {
            if (!validateNumber(soLuongNhap, soLuongNhapError, 1)) {
                e.preventDefault();
            }
        });

        formXuat.addEventListener('submit', e => {
            if (!validateNumber(soLuongXuat, soLuongXuatError, 1)) {
                e.preventDefault();
            }
        });

        formSua.addEventListener('submit', e => {
            if (!validateNumber(soLuongMoi, soLuongSuaError, 0)) {
                e.preventDefault();
            }
        });

        [{input: soLuongNhap, error: soLuongNhapError, min: 1},
            {input: soLuongXuat, error: soLuongXuatError, min: 1},
            {input: soLuongMoi, error: soLuongSuaError, min: 0}]
            .forEach(({input, error, min}) => {
                input.addEventListener('input', () => {
                    validateNumber(input, error, min);
                });
            });

        // auto tìm kiếm
        const keywordInput = document.querySelector('input[name="keyword"]');
        const form = keywordInput.closest('form');
        const loadingOverlay = document.getElementById("loading-overlay");
        const notificationContainer = document.createElement('div');
        notificationContainer.id = 'notification';
        notificationContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; display: none;';
        document.body.appendChild(notificationContainer);

        function showNotification(message, type = 'info') {
            notificationContainer.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
            notificationContainer.style.display = 'block';
            setTimeout(() => {
                notificationContainer.style.display = 'none';
            }, 1200);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function reinitializeEvents() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            tooltipTriggerList.forEach(function (el) {
                new bootstrap.Tooltip(el);
            });
            document.querySelectorAll(".btn-nhap").forEach(btn => {
                btn.addEventListener("click", function () {
                    document.getElementById("nhap-id").value = btn.getAttribute("data-id");
                });
            });

            document.querySelectorAll(".btn-xoa").forEach(btn => {
                btn.addEventListener("click", function () {
                    document.getElementById("xoa-id").value = btn.getAttribute("data-id");
                });
            });

            document.querySelectorAll(".btn-xuat").forEach(btn => {
                btn.addEventListener("click", function () {
                    document.getElementById("xuat-id").value = btn.getAttribute("data-id");
                });
            });
            document.querySelectorAll(".btn-sua").forEach(btn => {
                btn.addEventListener("click", function () {
                    document.getElementById("sua-id").value = btn.getAttribute("data-id");
                });
            });
            document.querySelectorAll('.pagination .page-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const url = this.getAttribute('href');
                    loadingOverlay.style.display = "flex";
                    fetch(url, {method: 'GET', headers: {'Accept': 'text/html'}})
                        .then(response => response.text())
                        .then(html => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const newContent = doc.querySelector("#table-container").innerHTML;
                            document.getElementById("table-container").innerHTML = newContent;
                            if (!doc.querySelector("#table-container").querySelector('tr')) {
                                showNotification('Không tìm thấy sản phẩm nào', 'warning');
                            }
                            reinitializeEvents();
                            loadingOverlay.style.display = "none";
                        })
                        .catch(error => {
                            console.error('Lỗi:', error);
                            showNotification('Đã xảy ra lỗi khi tải dữ liệu', 'danger');
                            loadingOverlay.style.display = "none";
                        });
                });
            });
        }

        const triggerSearch = debounce(() => {
            loadingOverlay.style.display = "flex";
            const formData = new FormData(form);
            const params = new URLSearchParams(formData).toString();
            fetch(`${form.action}?${params}`, {
                method: 'GET',
                headers: {'Accept': 'text/html'}
            })
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newContent = doc.querySelector("#table-container").innerHTML;
                    document.getElementById("table-container").innerHTML = newContent;
                    if (!doc.querySelector("#table-container").querySelector('tr')) {
                        showNotification('Không tìm thấy sản phẩm nào', 'warning');
                    }
                    reinitializeEvents();
                    loadingOverlay.style.display = "none";
                });
        }, 1200);

        keywordInput.addEventListener('input', triggerSearch);
        document.querySelector(".btn-filter").addEventListener("click", function (e) {
            e.preventDefault();
            triggerSearch();
        });
        document.querySelector(".btn-reset").addEventListener("click", function (e) {
            e.preventDefault();
            loadingOverlay.style.display = "flex";
            fetch('/quan-ly/kho', {method: 'GET', headers: {'Accept': 'text/html'}})
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newContent = doc.querySelector("#table-container").innerHTML;
                    document.getElementById("table-container").innerHTML = newContent;
                    if (!doc.querySelector("#table-container").querySelector('tr')) {
                        showNotification('Không tìm thấy sản phẩm nào', 'warning');
                    }
                    reinitializeEvents();
                    loadingOverlay.style.display = "none";
                    form.reset();
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    showNotification('Đã xảy ra lỗi khi đặt lại', 'danger');
                    loadingOverlay.style.display = "none";
                });
        });

        reinitializeEvents();

        // cảnh báo hàng ắp hết và gửi mail
    });
</script>

<!--phoóng to ảnh-->
<script>
    let imageModal;

    document.addEventListener('DOMContentLoaded', function () {
        imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    });

    function openImageModal(imgElement) {
        const zoomedImage = document.getElementById('zoomedImage');
        const productInfo = document.getElementById('productInfo');
        const imageSrc = imgElement.src;
        const productName = imgElement.getAttribute('data-product-name');
        const altText = imgElement.alt;
        zoomedImage.src = imageSrc;
        zoomedImage.alt = altText;
        productInfo.textContent = productName || altText || 'Sản phẩm';

        imageModal.show();
    }

    function closeImageModal() {
        imageModal.hide();
    }

    document.getElementById('imageModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeImageModal();
        }
    });
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && imageModal._isShown) {
            closeImageModal();
        }
    });
    document.querySelectorAll('.product-image').forEach(img => {
        img.addEventListener('error', function () {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGggIjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEg0MFY0MEgyMFYyMFoiIGZpbGw9IiM5Q0E0QUYiLz4KPHN0eWxlPi5jbGFzcyB7IGZvbnQtZmFtaWx5OiBBcmlhbCwgc2Fucy1zZXJpZjsgZm9udC1zaXplOiAxMnB4OyBmaWxsOiAjNkI3MjgwOyB9PC9zdHlsZT4KPHR4dCB4PSIzMCIgeT0iMzUiIGNsYXNzPSJjbGFzcyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Tm8gSW1hZ2U8L3R4dD4KPC9zdmc+';
            this.alt = 'Không thể tải hình ảnh';
        });
    });
</script>

<!--check vailidation add product-->
<script>
    let validationErrors = {};

    // Validation functions
    function validateProductName() {
        const input = document.getElementById('tenSanPham');
        const value = input.value.trim();

        clearFieldError('tenSanPham');

        if (!value) {
            setFieldError('tenSanPham', 'Tên sản phẩm không được để trống!');
            return false;
        }

        if (value.length < 2) {
            setFieldError('tenSanPham', 'Tên sản phẩm phải có ít nhất 2 ký tự!');
            return false;
        }

        if (value.length > 255) {
            setFieldError('tenSanPham', 'Tên sản phẩm không được vượt quá 255 ký tự!');
            return false;
        }

        // Kiểm tra ký tự đặc biệt
        const specialChars = /[<>:"/\\|?*]/;
        if (specialChars.test(value)) {
            setFieldError('tenSanPham', 'Tên sản phẩm không được chứa ký tự đặc biệt!');
            return false;
        }

        return true;
    }

    function validateBrand() {
        const input = document.getElementById('thuongHieu');
        const value = input.value;

        clearFieldError('thuongHieu');

        if (!value) {
            setFieldError('thuongHieu', 'Vui lòng chọn thương hiệu!');
            return false;
        }

        return true;
    }

    function validateCategory() {
        const input = document.getElementById('danhMuc');
        const value = input.value;

        clearFieldError('danhMuc');

        if (!value) {
            setFieldError('danhMuc', 'Vui lòng chọn danh mục!');
            return false;
        }

        return true;
    }

    function validateColor() {
        const input = document.getElementById('mauSac');
        const value = input.value.trim();

        clearFieldError('mauSac');

        if (!value) {
            setFieldError('mauSac', 'Màu sắc không được để trống!');
            return false;
        }

        if (value.length < 2) {
            setFieldError('mauSac', 'Màu sắc phải có ít nhất 2 ký tự!');
            return false;
        }

        if (value.length > 50) {
            setFieldError('mauSac', 'Màu sắc không được vượt quá 50 ký tự!');
            return false;
        }

        return true;
    }

    function validateSize() {
        const input = document.getElementById('kichThuoc');
        const value = input.value.trim();

        clearFieldError('kichThuoc');

        if (!value) {
            setFieldError('kichThuoc', 'Kích thước không được để trống!');
            return false;
        }

        if (value.length > 20) {
            setFieldError('kichThuoc', 'Kích thước không được vượt quá 20 ký tự!');
            return false;
        }

        return true;
    }

    function validateMaterial() {
        const input = document.getElementById('chatLieu');
        const value = input.value.trim();

        clearFieldError('chatLieu');

        if (!value) {
            setFieldError('chatLieu', 'Chất liệu không được để trống!');
            return false;
        }

        if (value.length < 2) {
            setFieldError('chatLieu', 'Chất liệu phải có ít nhất 2 ký tự!');
            return false;
        }

        if (value.length > 100) {
            setFieldError('chatLieu', 'Chất liệu không được vượt quá 100 ký tự!');
            return false;
        }

        return true;
    }

    function validatePrice() {
        const input = document.getElementById('giaNhap');
        const value = parseFloat(input.value);

        clearFieldError('giaNhap');

        if (!input.value || isNaN(value)) {
            setFieldError('giaNhap', 'Giá nhập không được để trống!');
            return false;
        }

        if (value <= 0) {
            setFieldError('giaNhap', 'Giá nhập phải lớn hơn 0!');
            return false;
        }

        if (value > 999999999) {
            setFieldError('giaNhap', 'Giá nhập không được vượt quá 999,999,999 VNĐ!');
            return false;
        }

        return true;
    }

    function validateQuantity() {
        const input = document.getElementById('soLuong');
        const value = parseInt(input.value);

        clearFieldError('soLuong');

        if (!input.value || isNaN(value)) {
            setFieldError('soLuong', 'Số lượng không được để trống!');
            return false;
        }

        if (value <= 0) {
            setFieldError('soLuong', 'Số lượng phải lớn hơn 0!');
            return false;
        }

        if (value > 999999) {
            setFieldError('soLuong', 'Số lượng không được vượt quá 999,999!');
            return false;
        }

        return true;
    }

    // Thêm function validation riêng cho việc kiểm tra hình ảnh có được chọn hay không
    function validateImageRequired() {
        const input = document.getElementById('hinhAnh');
        const hasFile = input.files && input.files.length > 0;

        clearFieldError('hinhAnh');

        if (!hasFile) {
            setFieldError('hinhAnh', 'Vui lòng chọn hình ảnh sản phẩm!');
            return false;
        }

        return true;
    }

    function validateAndPreviewImage(input) {
        const file = input.files[0];
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('preview');
        const imageInfo = document.getElementById('imageInfo');

        clearFieldError('hinhAnh');

        // Kiểm tra bắt buộc phải có file
        if (!file) {
            setFieldError('hinhAnh', 'Vui lòng chọn hình ảnh sản phẩm!');
            preview.style.display = 'none';
            return false;
        }

        if (file.size > 5 * 1024 * 1024) {
            setFieldError('hinhAnh', 'File không được vượt quá 5MB!');
            input.value = '';
            preview.style.display = 'none';
            return false;
        }

        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            setFieldError('hinhAnh', 'Chỉ chấp nhận file JPG, PNG, GIF!');
            input.value = '';
            preview.style.display = 'none';
            return false;
        }

        const fileName = file.name;
        const fileExtension = fileName.split('.').pop().toLowerCase();
        const allowedExtensions = ['jpg', 'jpeg', 'png', 'gif'];

        if (!allowedExtensions.includes(fileExtension)) {
            setFieldError('hinhAnh', 'Phần mở rộng file không hợp lệ!');
            input.value = '';
            preview.style.display = 'none';
            return false;
        }

        const invalidChars = /[<>:"/\\|?*]/;
        if (invalidChars.test(fileName)) {
            setFieldError('hinhAnh', 'Tên file không được chứa ký tự đặc biệt!');
            input.value = '';
            preview.style.display = 'none';
            return false;
        }

        // Show loading
        showLoading();

        // Tạo preview image và kiểm tra kích thước ảnh
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                hideLoading();

                // Kiểm tra kích thước ảnh
                if (this.width < 100 || this.height < 100) {
                    setFieldError('hinhAnh', 'Kích thước ảnh phải ít nhất 100x100 pixel!');
                    input.value = '';
                    preview.style.display = 'none';
                    return false;
                }

                if (this.width > 4000 || this.height > 4000) {
                    setFieldError('hinhAnh', 'Kích thước ảnh không được vượt quá 4000x4000 pixel!');
                    input.value = '';
                    preview.style.display = 'none';
                    return false;
                }

                // Hiển thị preview và thông tin ảnh
                previewImg.src = e.target.result;
                imageInfo.innerHTML = `
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            ${this.width}x${this.height}px, ${formatFileSize(file.size)}
                        </small>
                    `;
                preview.style.display = 'block';
                clearFieldError('hinhAnh');
            };

            img.onerror = function() {
                hideLoading();
                setFieldError('hinhAnh', 'File ảnh bị lỗi hoặc không hợp lệ!');
                input.value = '';
                preview.style.display = 'none';
                return false;
            };

            img.src = e.target.result;
        };

        reader.onerror = function() {
            hideLoading();
            setFieldError('hinhAnh', 'Không thể đọc file ảnh!');
            input.value = '';
            preview.style.display = 'none';
            return false;
        };

        reader.readAsDataURL(file);
        return true;
    }

    function removeImage() {
        document.getElementById('hinhAnh').value = '';
        document.getElementById('imagePreview').style.display = 'none';
        // Khi xóa ảnh thì sẽ báo lỗi thiếu hình ảnh
        setFieldError('hinhAnh', 'Vui lòng chọn hình ảnh sản phẩm!');
    }

    // Utility functions
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showLoading() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
    }

    function hideLoading() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }

    // Error handling functions
    function setFieldError(fieldName, message) {
        validationErrors[fieldName] = message;

        const input = document.getElementById(fieldName);
        const errorDiv = document.getElementById(fieldName + '-error');

        if (input) {
            input.classList.add('is-invalid');
            input.classList.remove('is-valid');
        }

        if (errorDiv) {
            errorDiv.textContent = message;
        }

        updateSubmitButton();
    }

    function clearFieldError(fieldName) {
        delete validationErrors[fieldName];

        const input = document.getElementById(fieldName);
        const errorDiv = document.getElementById(fieldName + '-error');

        if (input) {
            input.classList.remove('is-invalid');
            if (input.value.trim() || (fieldName === 'hinhAnh' && input.files.length > 0)) {
                input.classList.add('is-valid');
            }
        }

        if (errorDiv) {
            errorDiv.textContent = '';
        }

        updateSubmitButton();
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        const hasErrors = Object.keys(validationErrors).length > 0;

        if (submitBtn) {
            submitBtn.disabled = hasErrors;

            if (hasErrors) {
                submitBtn.classList.add('disabled');
            } else {
                submitBtn.classList.remove('disabled');
            }
        }
    }

    function validateForm() {
        validationErrors = {};

        const validations = [
            validateProductName(),
            validateBrand(),
            validateCategory(),
            validateColor(),
            validateSize(),
            validateMaterial(),
            validatePrice(),
            validateQuantity(),
            validateImageRequired() // Thêm validation bắt buộc hình ảnh
        ];

        // Nếu đã chọn file thì kiểm tra validation chi tiết
        const imageInput = document.getElementById('hinhAnh');
        if (imageInput && imageInput.files.length > 0) {
            validations.push(validateAndPreviewImage(imageInput));
        }

        const isValid = validations.every(result => result);

        if (!isValid) {
            showValidationAlert();
            return false;
        }

        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...';
            submitBtn.disabled = true;
        }

        return true;
    }

    function showValidationAlert() {
        const alert = document.getElementById('validationAlert');
        const errorsList = document.getElementById('validationErrors');

        if (errorsList) {
            errorsList.innerHTML = '';

            Object.values(validationErrors).forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorsList.appendChild(li);
            });
        }

        if (alert) {
            alert.classList.remove('d-none');
            const modalBody = document.querySelector('.modal-body');
            if (modalBody) {
                modalBody.scrollTop = 0;
            }

            setTimeout(() => {
                alert.classList.add('d-none');
            }, 5000);
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('addProductModal');

        if (modal) {
            modal.addEventListener('show.bs.modal', function() {
                const form = document.getElementById('formThem');
                if (form) {
                    form.reset();
                }

                const imagePreview = document.getElementById('imagePreview');
                if (imagePreview) {
                    imagePreview.style.display = 'none';
                }

                const validationAlert = document.getElementById('validationAlert');
                if (validationAlert) {
                    validationAlert.classList.add('d-none');
                }

                validationErrors = {};
                const inputs = modal.querySelectorAll('.form-control, .form-select');
                inputs.forEach(input => {
                    input.classList.remove('is-invalid', 'is-valid');
                });

                const errorDivs = modal.querySelectorAll('.invalid-feedback');
                errorDivs.forEach(div => {
                    div.textContent = '';
                });

                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Lưu sản phẩm';
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('disabled');
                }

                updateSubmitButton();
            });
        }

        const priceInput = document.getElementById('giaNhap');
        if (priceInput) {
            priceInput.addEventListener('blur', function() {
                const value = parseFloat(this.value);
                if (!isNaN(value)) {
                    this.value = value.toFixed(2);
                }
            });
        }

        const form = document.getElementById('formThem');
        if (form) {
            const inputs = form.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextInput = this.closest('.form-floating')?.nextElementSibling?.querySelector('input, select');
                        if (nextInput) {
                            nextInput.focus();
                        }
                    }
                });
            });
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>